import subprocess
import sys
from Scenario.telnetScenario import telnetScenario
from Scenario.smbScenario import smbScenario
from Scenario.httpScenario import httpScenario

try:
    print("Do nmap")
    args = ['nmap',sys.argv[1],'-sV']
    res = subprocess.check_output(args)
except:
    print("Error.")
#print(res.splitlines())

httpExist = 0
smbExist = 0
telnetExist = 0
sshExist = 0

for i in res.splitlines():
    tmp = i.decode('utf-8')
    if("/tcp" in tmp) &( not ("filterd" in tmp)):
        #output (port service version)
        print(tmp)
        count = 0
        encounterSpace = 0
        serviceBegin = 0
        serviceEnd = 0
        #output only version 
        for num in range(len(tmp)):
            #print(num)
            #print(count)

            if(encounterSpace ==1) & (tmp[num] != ' '):
                encounterSpace = 0
                if(count==3):
                    #print(tmp[num:len(tmp)])
                    break
                if(count==2):
                    serviceBegin = num
                
            if(encounterSpace==0) & (tmp[num]==' '):
                count+=1
                encounterSpace = 1
                if(serviceBegin != 0):
                    serviceName = tmp[serviceBegin:num]
                    #print(serviceName)
                    if(serviceName == "http"):
                        #print("http desu")
                        httpExist = 1            

                    if(serviceName == "netbios-ssn"):
                        #print("smb desu")
                        smbExist = 1

                    if(serviceName == "telnet"):
                        #print("telnet desu")
                        telnetExist = 1
                    if(serviceName == "ssh"):
                        sshExist = 1

if(httpExist == 1):
    #http senario function
    print("==================")
    print("http Senario Start")
    print("==================")
    httpScenario()

if(smbExist == 1):
    #smb senario function
    print("==================")
    print("smb Senario Start")
    print("==================")
    smbScenario()

if(telnetExist == 1 or sshExist == 1):
    #telnet senario function
    print("====================")
    print("telnet/ssh Senario Start")
    print("====================")
    telnetScenario(sys.argv[1])
