#!/usr/bin/env python3

import subprocess
import sys
from Scenario.telnetScenario import telnetScenario
from Scenario.smbScenario import smbScenario
from Scenario.httpScenario import httpScenario
from Scenario.httpScenario import run_findcve
from Scenario.searchCVE import searchCVE

try:
    print("Do nmap")
    args = ['nmap', sys.argv[1], '-sV']
    res = subprocess.check_output(args)
except:
    print("Error.")

httpExist = 0
smbExist = 0
telnetExist = 0
sshExist = 0

for i in res.splitlines():
    tmp = i.decode('utf-8')
    if ("/tcp" in tmp) & ( not ("filterd" in tmp)):
        print(tmp)
        count = 0
        encounterSpace = 0
        serviceBegin = 0
        serviceEnd = 0

        for num in range(len(tmp)):
            if (encounterSpace == 1) & (tmp[num] != ' '):
                encounterSpace = 0
                if (count == 3):
                    break
                if (count == 2):
                    serviceBegin = num

            if (encounterSpace == 0) & (tmp[num] == ' '):
                count += 1
                encounterSpace = 1
                if (serviceBegin != 0):
                    serviceName = tmp[serviceBegin:num]
                    if (serviceName == "http"):
                        httpExist = 1

                    if (serviceName == "netbios-ssn"):
                        smbExist = 1

                    if (serviceName == "telnet"):
                        telnetExist = 1
                    if (serviceName == "ssh"):
                        sshExist = 1


if (smbExist == 1):
    print("==================")
    print("smb Senario Start")
    print("==================")
    smbScenario()

if (telnetExist == 1 or sshExist == 1):
    print("====================")
    print("telnet/ssh Senario Start")
    print("====================")
    telnetScenario(sys.argv[1])

if (httpExist == 1):
    print("==================")
    print("http Senario Start")
    print("==================")
    httpScenario()
    print("==================")
    print("Search CVE PoC Start")
    print("==================")
    cve = run_findcve()
    searchCVE(cve)

